<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content" data-controller="tracker-form">

      <%= form_with url: trackers_path, method: :post, local: true do |f| %>
        <%= hidden_field_tag :date, selected_date %>

        <div class="modal-header d-flex flex-column align-items-center w-100">
          <h5 class="modal-title text-center">
            Habitudes & trackers<br>
            <%= l(selected_date, format: "%d %B %Y") %>
          </h5>
          <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
                  data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>

        <div class="modal-body">
          <% if habits_for_day.present? %>
            <% habits_for_day.each_with_index do |habit, index| %>
              <%= f.fields_for :trackers, trackers_by_habit[habit.id]&.first || Tracker.new, index: index do |hf| %>
                <div class="tracker-card mb-3 p-3">
                  <h5 class="mb-2 d-flex align-items-center">
                    <span class="me-2" style="display:inline-block;width:10px;height:10px;border-radius:50%; background:<%= habit.category&.color || '#999' %>"></span>
                    <%= habit.name %>
                  </h5>

                  <% if habit.goal.present? %>
                    <% frequency_text = case habit.goal.frequency.to_s.strip.downcase
                        when "day", "daily" then "par jour"
                        when "week", "weekly" then "par semaine"
                        when "month", "monthly" then "par mois"
                        else habit.goal.frequency
                      end %>
                    <p class="goal-info">
                      Ton objectif : <strong><%= habit.goal.value %> <%= habit.habit_type&.unit&.first %></strong>
                      <strong><%= frequency_text %></strong>
                    </p>
                  <% end %>

                  <%= hf.hidden_field :habit_id, value: habit.id %>
                  <div class="d-flex justify-content-center align-items-center gap-2">
                    <button type="button" class="btn-tracker" data-action="click->tracker-form#decrement">-</button>
                    <%= hf.number_field :value, value: trackers_by_habit.dig(habit.id, 0)&.value || 0,
                          class: "tracker-input text-center me-2",
                          style: "background: transparent; border: none; font-size: 18px; width: 50px; padding: 2px 0; line-height: 1;" %>
                    <span class="unit-display"><%= habit.habit_type&.unit&.first %></span>
                    <button type="button" class="btn-tracker" data-action="click->tracker-form#increment">+</button>
                  </div>

                  <hr class="tracker-separator" />

                  <div class="text-center">
                    <%= link_to "Suivi de mon habit", habit_path(habit), class: "tracker-show-link" %>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <p class="text-center">Aucune habit active ce jour l√†.</p>
          <% end %>
        </div>

        <div class="text-center mt-3">
          <%= f.submit "Valider", class: "btn btn-primary w-50" %>
        </div>
      <% end %>

    </div>
  </div>
</div>
